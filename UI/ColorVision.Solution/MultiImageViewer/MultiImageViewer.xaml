<UserControl x:Class="ColorVision.Solution.MultiImageViewer.MultiImageViewer"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:ColorVision.Solution.MultiImageViewer"
             xmlns:im="clr-namespace:ColorVision.ImageEditor;assembly=ColorVision.ImageEditor"
             mc:Ignorable="d" 
             d:DataContext="{d:DesignInstance local:MultiImageViewerConfig}"
             d:DesignHeight="600" d:DesignWidth="1000" 
             Background="{DynamicResource BorderBrush}" 
             Initialized="UserControl_Initialized">
    <UserControl.Resources>
        <Style TargetType="{x:Type TextBlock}">
            <Setter Property="Foreground" Value="{DynamicResource GlobalTextBrush}"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="TextTrimming" Value="CharacterEllipsis"/>
        </Style>
        
        <!-- 缩略图列表项模板 -->
        <DataTemplate x:Key="ThumbnailItemTemplate" DataType="{x:Type local:ImageFileInfo}">
            <Grid Margin="2" Width="130" Height="150" ToolTip="{Binding ImageInfoTooltip}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- 缩略图 -->
                <Border Grid.Row="0" Background="{DynamicResource GlobalBorderBrush}" 
                        BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" CornerRadius="3">
                    <Grid>
                        <Image Source="{Binding Thumbnail}" Stretch="Uniform" Margin="2"
                               RenderOptions.BitmapScalingMode="HighQuality"/>
                        
                        <!-- 加载中指示器 -->
                        <TextBlock Text="加载中..." HorizontalAlignment="Center" VerticalAlignment="Center"
                                   Visibility="{Binding IsLoadingThumbnail, Converter={StaticResource bool2VisibilityConverter}}"
                                   FontSize="10" Opacity="0.6"/>
                        
                        <!-- 文件不存在提示 -->
                        <TextBlock Text="文件不存在" HorizontalAlignment="Center" VerticalAlignment="Center"
                                   FontSize="10" Foreground="Red" Opacity="0.8">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding FileExists}" Value="False">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Grid>
                </Border>
                
                <!-- 文件名 -->
                <TextBlock Grid.Row="1" Text="{Binding FileName}" HorizontalAlignment="Center" 
                           TextTrimming="CharacterEllipsis" FontSize="11" Margin="2,2,2,0"
                           ToolTip="{Binding FileName}"/>
            </Grid>
        </DataTemplate>
        
        <!-- 列表项模板 -->
        <DataTemplate x:Key="ListItemTemplate" DataType="{x:Type local:ImageFileInfo}">
            <Grid Height="60" ToolTip="{Binding ImageInfoTooltip}">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="60"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <!-- 小缩略图 -->
                <Border Grid.Column="0" Background="{DynamicResource GlobalBorderBrush}" 
                        BorderBrush="{DynamicResource BorderBrush}" BorderThickness="1" 
                        CornerRadius="2" Margin="2">
                    <Image Source="{Binding Thumbnail}" Stretch="Uniform" Margin="1"
                           RenderOptions.BitmapScalingMode="HighQuality"/>
                </Border>
                
                <!-- 文件信息 -->
                <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="5,0">
                    <TextBlock Text="{Binding FileName}" FontWeight="Medium" FontSize="12"
                               TextTrimming="CharacterEllipsis" ToolTip="{Binding FileName}"/>
                    <TextBlock FontSize="10" Opacity="0.7">
                        <Run Text="{Binding ImageSizeDisplay, Mode=OneWay}"/>
                        <Run Text=" | "/>
                        <Run Text="{Binding FileSizeDisplay, Mode=OneWay}"/>
                    </TextBlock>
                    <TextBlock Text="{Binding LastModified, StringFormat=yyyy-MM-dd HH:mm}" 
                               FontSize="10" Opacity="0.5"/>
                </StackPanel>
            </Grid>
        </DataTemplate>
    </UserControl.Resources>
    
    <Grid x:Name="MainGrid">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto" MinWidth="150" MaxWidth="400"/>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        
        <!-- 左侧文件列表区域 -->
        <Grid Grid.Column="0" x:Name="FileListPanel" Width="200"
              Visibility="{Binding IsShowListView, Converter={StaticResource bool2VisibilityConverter}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="32"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <!-- 工具栏 -->
            <Border Grid.Row="0" Background="{DynamicResource GlobalBorderBrush}" BorderThickness="0,0,0,1" BorderBrush="{DynamicResource BorderBrush}">
                <DockPanel Margin="5,0">
                    <!-- 右侧设置按钮 -->
                    <StackPanel DockPanel.Dock="Right" Orientation="Horizontal">
                        <!-- 刷新按钮 -->
                        <Button x:Name="RefreshButton" Click="RefreshButton_Click" Padding="2" Height="25" Width="25" Margin="2,0" ToolTip="刷新">
                            <TextBlock Text="&#xE72C;" FontFamily="Segoe MDL2 Assets" FontSize="14" 
                                       Foreground="{DynamicResource GlobalTextBrush}" HorizontalAlignment="Center"/>
                        </Button>
                        
                        <!-- 设置按钮 -->
                        <Button Command="{Binding EditCommand}" Padding="2" Height="25" Width="25" ToolTip="设置">
                            <Button.Triggers>
                                <EventTrigger RoutedEvent="Button.Click">
                                    <BeginStoryboard>
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="rotateTransform" 
                                                             Storyboard.TargetProperty="Angle" 
                                                             From="0" To="360" Duration="0:0:0.5" FillBehavior="Stop"/>
                                        </Storyboard>
                                    </BeginStoryboard>
                                </EventTrigger>
                            </Button.Triggers>
                            <TextBlock Text="&#xE713;" HorizontalAlignment="Center" FontFamily="Segoe MDL2 Assets" 
                                       RenderTransformOrigin="0.5,0.5" FontSize="16" 
                                       Foreground="{DynamicResource GlobalTextBrush}">
                                <TextBlock.RenderTransform>
                                    <RotateTransform x:Name="rotateTransform"/>
                                </TextBlock.RenderTransform>
                            </TextBlock>
                        </Button>
                    </StackPanel>
                    
                    <!-- 左侧显示数量 -->
                    <TextBlock x:Name="FileCountText" VerticalAlignment="Center" FontSize="12" Opacity="0.8"/>
                </DockPanel>
            </Border>
            
            <!-- 文件列表 -->
            <ListBox x:Name="FileListBox" Grid.Row="1" 
                     BorderThickness="0" 
                     Background="Transparent"
                     SelectionChanged="FileListBox_SelectionChanged"
                     ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                     VirtualizingPanel.IsVirtualizing="True"
                     VirtualizingPanel.VirtualizationMode="Recycling"
                     ItemTemplate="{StaticResource ListItemTemplate}">
                <ListBox.ItemContainerStyle>
                    <Style TargetType="ListBoxItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0,1"/>
                        <Setter Property="Cursor" Value="Hand"/>
                        <Style.Triggers>
                            <DataTrigger Binding="{Binding FileExists}" Value="False">
                                <Setter Property="Opacity" Value="0.5"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </ListBox.ItemContainerStyle>
                <ListBox.ContextMenu>
                    <ContextMenu>
                        <MenuItem Header="在资源管理器中打开" Click="OpenInExplorer_Click"/>
                        <MenuItem Header="复制文件路径" Click="CopyFilePath_Click"/>
                        <Separator/>
                        <MenuItem Header="刷新" Click="RefreshButton_Click"/>
                    </ContextMenu>
                </ListBox.ContextMenu>
            </ListBox>
        </Grid>
        
        <!-- 分隔条 -->
        <GridSplitter Grid.Column="1" Width="4" HorizontalAlignment="Center" 
                      VerticalAlignment="Stretch" Background="#1FFFFFFF"
                      Visibility="{Binding IsShowListView, Converter={StaticResource bool2VisibilityConverter}}"/>
        
        <!-- 右侧图像预览区域 -->
        <Grid Grid.Column="2">
            <im:ImageView x:Name="ImageView"/>
            
            <!-- 无图像时的提示 -->
            <TextBlock x:Name="NoImageHint" Text="请从左侧列表选择图片" 
                       HorizontalAlignment="Center" VerticalAlignment="Center"
                       FontSize="16" Opacity="0.5" Visibility="Visible"/>
        </Grid>
    </Grid>
</UserControl>
