# RBAC ä¼˜åŒ–å®æ–½å¿«é€Ÿå‚è€ƒ

## ğŸ¯ ç¬¬ä¸€å‘¨ä»»åŠ¡æ¸…å•

### Day 1-2: æœåŠ¡æ¥å£å®šä¹‰

#### åˆ›å»ºæ–°æ–‡ä»¶
```
UI/ColorVision.Solution/Rbac/Services/
â”œâ”€â”€ IRoleService.cs          [æ–°å»º]
â”œâ”€â”€ ITenantService.cs        [æ–°å»º]
â”œâ”€â”€ ISessionService.cs       [æ–°å»º]
â””â”€â”€ IPermissionChecker.cs    [æ–°å»º]
```

#### æ ¸å¿ƒä»£ç æ¨¡æ¿

**IRoleService.cs**
```csharp
namespace ColorVision.Rbac.Services
{
    public interface IRoleService
    {
        Task<List<RoleEntity>> GetAllRolesAsync(CancellationToken ct = default);
        Task<RoleEntity?> GetRoleByIdAsync(int roleId, CancellationToken ct = default);
        Task<bool> CreateRoleAsync(string name, string code, string? remark = null, CancellationToken ct = default);
        Task<bool> UpdateRoleAsync(int roleId, string name, string? remark = null, CancellationToken ct = default);
        Task<bool> DeleteRoleAsync(int roleId, CancellationToken ct = default);
        Task<List<PermissionEntity>> GetRolePermissionsAsync(int roleId, CancellationToken ct = default);
        Task<bool> AssignPermissionsToRoleAsync(int roleId, IEnumerable<int> permissionIds, CancellationToken ct = default);
    }
}
```

### Day 3-4: å®ç°æœåŠ¡ç±»

#### åˆ›å»ºå®ç°
```
UI/ColorVision.Solution/Rbac/Services/
â”œâ”€â”€ RoleService.cs           [æ–°å»º]
â”œâ”€â”€ TenantService.cs         [æ–°å»º]
â”œâ”€â”€ SessionService.cs        [æ–°å»º]
â””â”€â”€ PermissionChecker.cs     [æ–°å»º]
```

#### RoleService å®ç°é‡ç‚¹
```csharp
public class RoleService : IRoleService
{
    private readonly ISqlSugarClient _db;
    private readonly IAuditLogService _auditLog;

    public RoleService(ISqlSugarClient db, IAuditLogService auditLog)
    {
        _db = db;
        _auditLog = auditLog;
    }

    // å®ç°æ‰€æœ‰æ¥å£æ–¹æ³•
    // æ³¨æ„ï¼šæ¯ä¸ªä¿®æ”¹æ“ä½œéƒ½è¦è®°å½•å®¡è®¡æ—¥å¿—
}
```

### Day 5: é‡æ„ RbacManager

#### ä¿®æ”¹æ–‡ä»¶
- `UI/ColorVision.Solution/Rbac/RbacManager.cs` [ä¿®æ”¹]

#### é‡æ„è¦ç‚¹
1. ç§»é™¤ç›´æ¥çš„æ•°æ®åº“æ“ä½œä»£ç 
2. æ³¨å…¥æ–°çš„æœåŠ¡å®ä¾‹
3. ä¿æŒå…¬å…± API å‘åå…¼å®¹

```csharp
public class RbacManager : IDisposable
{
    // æ–°å¢æœåŠ¡å±æ€§
    public IRoleService RoleService { get; }
    public ITenantService TenantService { get; }
    public ISessionService SessionService { get; }
    public IPermissionChecker PermissionChecker { get; }

    private RbacManager()
    {
        // åˆå§‹åŒ–æ•°æ®åº“
        InitializeDatabase();
        
        // åˆå§‹åŒ–æœåŠ¡
        AuthService = new AuthService(_db);
        AuditLogService = new AuditLogService(_db);
        UserService = new UserService(_db, AuditLogService);
        RoleService = new RoleService(_db, AuditLogService);  // æ–°å¢
        PermissionService = new PermissionService(_db);
        TenantService = new TenantService(_db);                // æ–°å¢
        SessionService = new SessionService(_db);              // æ–°å¢
        PermissionChecker = new PermissionChecker(_db);        // æ–°å¢
        
        // ... å…¶ä»–åˆå§‹åŒ–ä»£ç 
    }

    // å°†åŸæ¥çš„ CreateRole æ–¹æ³•å§”æ‰˜ç»™ RoleService
    public bool CreateRole(string name, string code, string remark = "")
    {
        try
        {
            if (Authorization.Instance.PermissionMode > PermissionMode.Administrator)
            {
                throw new PermissionDeniedException("å½“å‰ç”¨æˆ·æ— æƒåˆ›å»ºè§’è‰²");
            }

            var result = RoleService.CreateRoleAsync(name, code, remark)
                .GetAwaiter().GetResult();
            
            return result;
        }
        catch (Exception ex)
        {
            _logger?.LogError(ex, "Failed to create role");
            MessageBox.Show($"åˆ›å»ºè§’è‰²å¤±è´¥: {ex.Message}", "é”™è¯¯", 
                MessageBoxButton.OK, MessageBoxImage.Error);
            return false;
        }
    }
}
```

---

## ğŸ¯ ç¬¬äºŒå‘¨ä»»åŠ¡æ¸…å•

### Day 6-8: æƒé™æ£€æŸ¥å™¨å®ç°

#### åˆ›å»ºæ–°æ–‡ä»¶
```
UI/ColorVision.Solution/Rbac/
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ IPermissionChecker.cs    [æ–°å»º]
â”‚   â””â”€â”€ PermissionChecker.cs     [æ–°å»º]
â””â”€â”€ Attributes/
    â””â”€â”€ RequirePermissionAttribute.cs  [æ–°å»º]
```

#### PermissionChecker æ ¸å¿ƒå®ç°
```csharp
public class PermissionChecker : IPermissionChecker
{
    private readonly ISqlSugarClient _db;
    private readonly IMemoryCache _cache;
    private const int CacheMinutes = 5;

    public async Task<bool> HasPermissionAsync(int userId, string permissionCode)
    {
        var userPermissions = await GetUserPermissionCodesAsync(userId);
        return userPermissions.Contains(permissionCode);
    }

    public async Task<List<string>> GetUserPermissionCodesAsync(int userId)
    {
        var cacheKey = $"user_permissions_{userId}";
        
        if (_cache != null && _cache.TryGetValue(cacheKey, out List<string> cached))
            return cached;

        // æŸ¥è¯¢ç”¨æˆ·è§’è‰²
        var roleIds = await _db.Queryable<UserRoleEntity>()
            .Where(ur => ur.UserId == userId)
            .Select(ur => ur.RoleId)
            .ToListAsync();

        if (roleIds.Count == 0)
            return new List<string>();

        // æŸ¥è¯¢è§’è‰²æƒé™
        var permissions = await _db.Queryable<RolePermissionEntity>()
            .InnerJoin<PermissionEntity>((rp, p) => rp.PermissionId == p.Id)
            .Where((rp, p) => roleIds.Contains(rp.RoleId) && p.IsEnable && p.IsDelete != true)
            .Select((rp, p) => p.Code)
            .Distinct()
            .ToListAsync();

        // ç¼“å­˜
        _cache?.Set(cacheKey, permissions, TimeSpan.FromMinutes(CacheMinutes));
        
        return permissions;
    }
}
```

#### ä½¿ç”¨ç¤ºä¾‹
```csharp
// åœ¨éœ€è¦æ£€æŸ¥æƒé™çš„åœ°æ–¹
var checker = RbacManager.GetInstance().PermissionChecker;
var hasPermission = await checker.HasPermissionAsync(userId, "user.create");

if (!hasPermission)
{
    throw new PermissionDeniedException("æ— æƒåˆ›å»ºç”¨æˆ·");
}
```

### Day 9-10: æ‰©å±•æƒé™ç§å­æ•°æ®

#### ä¿®æ”¹æ–‡ä»¶
- `UI/ColorVision.Solution/Rbac/Services/PermissionService.cs` [ä¿®æ”¹]

#### æ‰©å±•æƒé™å®šä¹‰
```csharp
public async Task EnsureSeedAsync()
{
    var seeds = new List<PermissionEntity>
    {
        // ç”¨æˆ·ç®¡ç†
        new() { Name="åˆ›å»ºç”¨æˆ·", Code="user.create", Group="User" },
        new() { Name="ç¼–è¾‘ç”¨æˆ·", Code="user.edit", Group="User" },
        new() { Name="åˆ é™¤ç”¨æˆ·", Code="user.delete", Group="User" },
        new() { Name="æŸ¥çœ‹ç”¨æˆ·", Code="user.view", Group="User" },
        new() { Name="é‡ç½®å¯†ç ", Code="user.reset_password", Group="User" },
        
        // è§’è‰²ç®¡ç†
        new() { Name="åˆ›å»ºè§’è‰²", Code="role.create", Group="Role" },
        new() { Name="ç¼–è¾‘è§’è‰²", Code="role.edit", Group="Role" },
        new() { Name="åˆ é™¤è§’è‰²", Code="role.delete", Group="Role" },
        new() { Name="æŸ¥çœ‹è§’è‰²", Code="role.view", Group="Role" },
        new() { Name="åˆ†é…æƒé™", Code="role.assign_permissions", Group="Role" },
        
        // æƒé™ç®¡ç†
        new() { Name="æŸ¥çœ‹æƒé™", Code="permission.view", Group="Permission" },
        new() { Name="ç®¡ç†æƒé™", Code="permission.manage", Group="Permission" },
        
        // å®¡è®¡æ—¥å¿—
        new() { Name="æŸ¥çœ‹å®¡è®¡æ—¥å¿—", Code="audit.view", Group="Audit" },
        new() { Name="å¯¼å‡ºå®¡è®¡æ—¥å¿—", Code="audit.export", Group="Audit" },
        
        // ç§Ÿæˆ·ç®¡ç†
        new() { Name="åˆ›å»ºç§Ÿæˆ·", Code="tenant.create", Group="Tenant" },
        new() { Name="ç¼–è¾‘ç§Ÿæˆ·", Code="tenant.edit", Group="Tenant" },
        new() { Name="æŸ¥çœ‹ç§Ÿæˆ·", Code="tenant.view", Group="Tenant" },
    };

    // ... æ’å…¥é€»è¾‘
}
```

---

## ğŸ¯ ç¬¬ä¸‰å‘¨ä»»åŠ¡æ¸…å•

### Day 11-13: ä¼šè¯ç®¡ç†å®ç°

#### åˆ›å»ºæ–°æ–‡ä»¶
```
UI/ColorVision.Solution/Rbac/
â”œâ”€â”€ Entity/
â”‚   â””â”€â”€ SessionEntity.cs         [æ–°å»º]
â””â”€â”€ Services/
    â”œâ”€â”€ ISessionService.cs       [æ–°å»º]
    â””â”€â”€ SessionService.cs        [æ–°å»º]
```

#### SessionEntity å®šä¹‰
```csharp
[SugarTable("sys_session")]
public class SessionEntity
{
    [SugarColumn(IsPrimaryKey = true, IsIdentity = true, ColumnName = "id")]
    public int Id { get; set; }

    [SugarColumn(ColumnName = "user_id")]
    public int UserId { get; set; }

    [SugarColumn(ColumnName = "session_token", Length = 128)]
    public string SessionToken { get; set; } = string.Empty;

    [SugarColumn(ColumnName = "created_at")]
    public DateTimeOffset CreatedAt { get; set; } = DateTimeOffset.UtcNow;

    [SugarColumn(ColumnName = "expires_at")]
    public DateTimeOffset ExpiresAt { get; set; }

    [SugarColumn(ColumnName = "is_revoked")]
    public bool IsRevoked { get; set; } = false;
}
```

#### åœ¨ RbacManager ä¸­åˆå§‹åŒ–è¡¨
```csharp
private void InitializeDatabase()
{
    // ... ç°æœ‰ä»£ç 
    _db.CodeFirst.InitTables<SessionEntity>();  // æ–°å¢
}
```

### Day 14-15: å¼‚å¸¸å¤„ç†ä¼˜åŒ–

#### åˆ›å»ºæ–°æ–‡ä»¶
```
UI/ColorVision.Solution/Rbac/
â””â”€â”€ Exceptions/
    â”œâ”€â”€ RbacException.cs                [æ–°å»º]
    â”œâ”€â”€ PermissionDeniedException.cs    [æ–°å»º]
    â”œâ”€â”€ InvalidCredentialsException.cs  [æ–°å»º]
    â””â”€â”€ UserNotFoundException.cs        [æ–°å»º]
```

#### åŸºç¡€å¼‚å¸¸ç±»
```csharp
public class RbacException : Exception
{
    public string ErrorCode { get; }

    public RbacException(string message, string errorCode = "RBAC_ERROR") 
        : base(message)
    {
        ErrorCode = errorCode;
    }
}

public class PermissionDeniedException : RbacException
{
    public PermissionDeniedException(string message) 
        : base(message, "PERMISSION_DENIED") { }
}
```

#### æ›¿æ¢ç©º catch å—
åœ¨æ‰€æœ‰ç°æœ‰ä»£ç ä¸­æœç´¢ `catch { }` å¹¶æ›¿æ¢ä¸º:
```csharp
catch (Exception ex)
{
    _logger?.LogError(ex, "Operation failed");
    // é€‚å½“çš„é”™è¯¯å¤„ç†
}
```

---

## ğŸ“‹ ä¿®æ”¹æ¸…å•ï¼ˆæŒ‰æ–‡ä»¶ï¼‰

### éœ€è¦æ–°å»ºçš„æ–‡ä»¶ï¼ˆä¼˜å…ˆçº§é«˜ï¼‰
1. âœ… `Services/IRoleService.cs`
2. âœ… `Services/RoleService.cs`
3. âœ… `Services/IPermissionChecker.cs`
4. âœ… `Services/PermissionChecker.cs`
5. âœ… `Services/ISessionService.cs`
6. âœ… `Services/SessionService.cs`
7. âœ… `Entity/SessionEntity.cs`
8. âœ… `Exceptions/RbacException.cs`
9. âœ… `Exceptions/PermissionDeniedException.cs`

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
1. âœ… `RbacManager.cs` - é‡æ„ä¸ºä½¿ç”¨æœåŠ¡å±‚
2. âœ… `PermissionService.cs` - æ‰©å±•æƒé™ç§å­
3. âœ… `UserManagerWindow.xaml.cs` - æ”¹è¿›å¼‚å¸¸å¤„ç†
4. âœ… `LoginWindow.xaml.cs` - æ·»åŠ ä¼šè¯ç®¡ç†

---

## ğŸ§ª æµ‹è¯•æ£€æŸ¥ç‚¹

### ç¬¬ä¸€å‘¨ç»“æŸæ£€æŸ¥
- [ ] æ‰€æœ‰æœåŠ¡æ¥å£å·²å®šä¹‰
- [ ] RoleService å¯ä»¥åˆ›å»ºã€æŸ¥è¯¢è§’è‰²
- [ ] RbacManager å·²é‡æ„ï¼Œå‘åå…¼å®¹
- [ ] ç°æœ‰åŠŸèƒ½ä»æ­£å¸¸å·¥ä½œ

### ç¬¬äºŒå‘¨ç»“æŸæ£€æŸ¥
- [ ] PermissionChecker å¯ä»¥æ£€æŸ¥æƒé™
- [ ] æƒé™ç¼“å­˜æ­£å¸¸å·¥ä½œ
- [ ] ç§å­æƒé™å·²æ‰©å±•
- [ ] å¯ä»¥åŸºäºæƒé™ code è¿›è¡Œæ§åˆ¶

### ç¬¬ä¸‰å‘¨ç»“æŸæ£€æŸ¥
- [ ] ä¼šè¯å¯ä»¥åˆ›å»ºå’ŒéªŒè¯
- [ ] ä¼šè¯è¿‡æœŸæœºåˆ¶å·¥ä½œæ­£å¸¸
- [ ] å¼‚å¸¸å¤„ç†å·²æ”¹è¿›
- [ ] æ—¥å¿—è®°å½•å®Œå–„

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•å¤„ç†å‘åå…¼å®¹æ€§ï¼Ÿ
A: ä¿æŒ RbacManager çš„å…¬å…± API ä¸å˜ï¼Œå†…éƒ¨å®ç°æ”¹ä¸ºè°ƒç”¨æœåŠ¡å±‚ã€‚

### Q2: æ˜¯å¦éœ€è¦ç«‹å³æ·»åŠ ç¼“å­˜ï¼Ÿ
A: å»ºè®®åœ¨ PermissionChecker ä¸­ç›´æ¥ä½¿ç”¨ç®€å•çš„å†…å­˜ç¼“å­˜ï¼ˆDictionaryï¼‰ï¼Œåç»­å†ä¼˜åŒ–ä¸º IMemoryCacheã€‚

### Q3: ä¼šè¯ç®¡ç†æ˜¯å¦å¿…é¡»ï¼Ÿ
A: å¯ä»¥å»¶åå®æ–½ï¼Œä½†å»ºè®®å°½æ—©å®Œæˆä»¥æå‡å®‰å…¨æ€§ã€‚

### Q4: å¦‚ä½•æµ‹è¯•æƒé™æ£€æŸ¥ï¼Ÿ
A: å»ºè®®ç¼–å†™ç®€å•çš„æ§åˆ¶å°æµ‹è¯•æˆ–å•å…ƒæµ‹è¯•éªŒè¯ã€‚

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœåœ¨å®æ–½è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼š
1. æŸ¥çœ‹ `OPTIMIZATION_PLAN.md` è·å–è¯¦ç»†ä»£ç ç¤ºä¾‹
2. æŸ¥çœ‹ `ä¼˜åŒ–æ€»ç»“.md` äº†è§£æ•´ä½“æ–¹æ¡ˆ
3. å‚è€ƒç°æœ‰ä»£ç çš„å®ç°æ¨¡å¼

---

**å¿«é€Ÿå‚è€ƒç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-12-15
