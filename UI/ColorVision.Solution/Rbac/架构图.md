# RBAC 优化架构图

## 当前架构（简化版）

```
┌─────────────────────────────────────────────────────────────┐
│                      ColorVision UI                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │ LoginWindow  │  │UserManager   │  │RbacManager   │      │
│  │              │  │Window        │  │Window        │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         │                 │                 │              │
│         └─────────────────┼─────────────────┘              │
│                           │                                │
└───────────────────────────┼────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    RbacManager (Singleton)                  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  直接数据库操作 + 业务逻辑 + UI命令                     │  │
│  │  - CreateUser()                                       │  │
│  │  - CreateRole()                                       │  │
│  │  - GetUsers()                                         │  │
│  │  - UpdateUserRoles()                                  │  │
│  │  - db.Queryable<>()...  (混在一起)                    │  │
│  └──────────────────────────────────────────────────────┘  │
│                           │                                 │
│  ┌──────────────┐  ┌─────┴──────┐  ┌──────────────┐       │
│  │ AuthService  │  │ UserService│  │ AuditLog     │       │
│  │              │  │            │  │ Service      │       │
│  └──────────────┘  └────────────┘  └──────────────┘       │
└───────────────────────────────────────────────────────────┘
                            │
                            ▼
                    ┌───────────────┐
                    │  SQLite DB    │
                    │  (Rbac.db)    │
                    └───────────────┘

问题：
❌ RbacManager 职责过重
❌ 业务逻辑与数据访问混在一起
❌ 缺少权限检查器
❌ 缺少会话管理
```

---

## 优化后架构（目标）

```
┌─────────────────────────────────────────────────────────────────────┐
│                          ColorVision UI                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐             │
│  │ LoginWindow  │  │UserManager   │  │Permission    │             │
│  │              │  │Window        │  │ManagerWindow │             │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘             │
│         │                 │                 │                     │
│         └─────────────────┼─────────────────┘                     │
│                           │                                        │
└───────────────────────────┼────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    RbacManager (Facade/轻量级)                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  仅作为门面，协调各个服务                                      │  │
│  │  - LoginCommand                                               │  │
│  │  - OpenUserManagerCommand                                     │  │
│  │  - Config (配置)                                              │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                           │                                         │
│  ┌──────────┬─────────────┴──────────────┬──────────────┐         │
│  │          │                            │              │         │
│  ▼          ▼                            ▼              ▼         │
│ ┌─────────────────┐  ┌──────────────────────────────────────┐    │
│ │  IAuthService   │  │      服务层 (Service Layer)          │    │
│ │  └───────┬──────┘  │                                      │    │
│ │  AuthService      │  ├─ IRoleService → RoleService       │    │
│ └───────────────────┘  │  ├─ IUserService → UserService    │    │
│                        │  ├─ IPermissionService →          │    │
│ ┌───────────────────┐  │  │   PermissionService            │    │
│ │IPermissionChecker │  │  ├─ ITenantService → TenantService│    │
│ │  └────┬───────────┘  │  ├─ ISessionService →            │    │
│ │  PermissionChecker│  │  │   SessionService               │    │
│ │  (带缓存)         │  │  └─ IAuditLogService →           │    │
│ └───────────────────┘  │      AuditLogService              │    │
│                        └──────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
                            │
                            ▼
                    ┌────────────────┐
                    │ Repository层   │  (可选，当前直接用SqlSugar)
                    └────────┬───────┘
                            │
                            ▼
                    ┌────────────────┐
                    │  SQLite DB     │
                    │  (Rbac.db)     │
                    │                │
                    │  新增表：       │
                    │  - sys_session │
                    │  - sys_password│
                    │    _history    │
                    └────────────────┘

优势：
✅ 清晰的分层架构
✅ 业务逻辑封装在服务层
✅ 权限检查统一管理
✅ 会话管理独立服务
✅ 更容易测试和维护
```

---

## 权限检查流程对比

### 当前流程（基于 PermissionMode）

```
用户操作
   │
   ▼
检查 Authorization.Instance.PermissionMode
   │
   ├─ SuperAdministrator (0) → ✅ 允许所有操作
   ├─ Administrator (1)      → ✅ 允许大部分操作
   ├─ Advanced (2)           → ⚠️ 部分限制
   └─ Normal (3)             → ❌ 限制较多

问题：
❌ 权限粒度太粗
❌ 不灵活，无法细粒度控制
```

### 优化后流程（基于 Permission Code）

```
用户操作 (例如: 创建用户)
   │
   ▼
调用 PermissionChecker.HasPermissionAsync(userId, "user.create")
   │
   ▼
检查缓存
   │
   ├─ 缓存命中 → 直接返回结果
   │
   └─ 缓存未命中
       │
       ▼
   查询数据库
       │
       ├─ 1. 查询用户的角色 (UserRole)
       ├─ 2. 查询角色的权限 (RolePermission)
       └─ 3. 返回权限代码列表
       │
       ▼
   检查是否包含 "user.create"
       │
       ├─ Yes → ✅ 允许操作
       └─ No  → ❌ 拒绝操作
       │
       ▼
   缓存结果（5分钟）

优势：
✅ 细粒度控制
✅ 灵活的权限分配
✅ 性能优化（缓存）
✅ 符合标准 RBAC 模型
```

---

## 数据模型关系图

```
┌─────────────┐          ┌─────────────┐          ┌─────────────┐
│   Tenant    │          │    User     │          │    Role     │
│   租户      │          │    用户     │          │    角色     │
├─────────────┤          ├─────────────┤          ├─────────────┤
│ Id          │          │ Id          │          │ Id          │
│ Name        │          │ Username    │          │ Name        │
│ Code        │          │ Password    │          │ Code        │
│ ...         │          │ IsEnable    │          │ IsEnable    │
└─────────────┘          │ ...         │          │ ...         │
       │                 └─────────────┘          └─────────────┘
       │                        │                        │
       │                        │                        │
       │                        │                        │
       │                 ┌──────┴────────┐        ┌──────┴────────┐
       │                 │               │        │               │
       └────────┐        │               │        │               │
                │        │               │        │               │
                ▼        ▼               ▼        ▼               ▼
        ┌─────────────────────┐  ┌─────────────────────┐  ┌──────────────┐
        │   UserTenant        │  │    UserRole         │  │RolePermission│
        │   用户-租户关联     │  │    用户-角色关联    │  │角色-权限关联 │
        ├─────────────────────┤  ├─────────────────────┤  ├──────────────┤
        │ UserId              │  │ UserId              │  │ RoleId       │
        │ TenantId            │  │ RoleId              │  │ PermissionId │
        └─────────────────────┘  └─────────────────────┘  └──────────────┘
                                                                   │
                                                                   │
                                                                   ▼
                                                          ┌─────────────┐
                                                          │ Permission  │
                                                          │   权限      │
                                                          ├─────────────┤
                                                          │ Id          │
                                                          │ Code        │
                                                          │ Name        │
                                                          │ Group       │
                                                          │ ...         │
                                                          └─────────────┘

┌─────────────┐          ┌─────────────┐
│UserDetail   │          │ AuditLog    │
│ 用户详情    │          │  审计日志   │
├─────────────┤          ├─────────────┤
│ UserId      │          │ UserId      │
│ Email       │          │ Username    │
│ Phone       │          │ Action      │
│ PermissionMode│        │ Detail      │
│ ...         │          │ CreatedAt   │
└─────────────┘          │ ...         │
                         └─────────────┘

┌─────────────┐          ┌──────────────────┐
│  Session    │          │PasswordHistory   │
│  会话(新增) │          │ 密码历史(新增)   │
├─────────────┤          ├──────────────────┤
│ UserId      │          │ UserId           │
│ SessionToken│          │ PasswordHash     │
│ ExpiresAt   │          │ CreatedAt        │
│ IsRevoked   │          └──────────────────┘
│ ...         │
└─────────────┘
```

---

## 优化实施时间线

```
Week 1-2: 基础架构重构
├─ Day 1-2:   创建服务接口层
├─ Day 3-4:   实现服务类
├─ Day 5-6:   重构 RbacManager
├─ Day 7-8:   实现 PermissionChecker
└─ Day 9-10:  扩展权限种子数据

Week 3: 会话管理与异常处理
├─ Day 11-13: 实现会话管理
├─ Day 14-15: 优化异常处理
└─ 测试和文档

Week 4: 功能完善（中优先级）
├─ 租户功能激活
├─ 密码策略
└─ 审计日志 UI

Week 5-6: 性能优化与测试
├─ 添加缓存层
├─ 编写单元测试
└─ 集成依赖注入

总计：约 6 周（可根据实际情况调整）
```

---

## 关键指标

### 代码质量指标（优化前 vs 优化后）

| 指标 | 优化前 | 优化后目标 | 说明 |
|------|--------|-----------|------|
| 服务层抽象 | ❌ 无 | ✅ 7个服务接口 | IRoleService, IUserService 等 |
| 权限粒度 | ⚠️ 粗粒度(4级) | ✅ 细粒度(17+权限) | 基于 permission code |
| 异常处理 | ❌ 多处空catch | ✅ 统一异常体系 | RbacException 及子类 |
| 会话管理 | ❌ 无 | ✅ Token + 超时 | SessionService |
| 权限缓存 | ❌ 无 | ✅ 5分钟缓存 | MemoryCache |
| 单元测试覆盖 | ❌ 0% | ✅ >70% | 核心服务层 |
| 审计日志UI | ❌ 无 | ✅ 查询+导出 | AuditLogWindow |
| 多租户支持 | ⚠️ 实体未激活 | ✅ 完整支持 | TenantService |

### 性能指标（预期）

| 操作 | 优化前 | 优化后 | 改进 |
|------|--------|--------|------|
| 权限检查 | ~50ms | ~5ms | 10x ⚡ |
| 登录 | ~200ms | ~150ms | 1.3x |
| 角色权限查询 | ~100ms | ~10ms | 10x ⚡ |

---

## 文档版本

- **版本**: 1.0
- **创建日期**: 2025-12-15
- **最后更新**: 2025-12-15
- **维护者**: ColorVision 开发团队
