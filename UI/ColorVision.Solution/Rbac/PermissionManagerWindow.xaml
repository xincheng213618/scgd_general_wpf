<Window x:Class="ColorVision.Rbac.PermissionManagerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:hc="https://handyorg.github.io/handycontrol"
        mc:Ignorable="d"
        Title="权限管理" Height="600" Width="900" 
        Background="{DynamicResource GlobalBackground}"
        WindowStartupLocation="CenterOwner"
        Initialized="Window_Initialized">
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- 标题 -->
        <TextBlock Grid.Row="0" Text="角色权限管理" FontSize="18" FontWeight="Bold" Margin="0,0,0,10"/>
        
        <!-- 主内容区 -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="10"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- 左侧：角色列表 -->
            <GroupBox Grid.Column="0" Header="角色列表">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <ListBox x:Name="RolesListBox" 
                             Grid.Row="0"
                             SelectionChanged="RolesListBox_SelectionChanged"
                             DisplayMemberPath="Name"/>
                    
                    <StackPanel Grid.Row="1" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,5,0,0">
                        <Button Content="刷新" Width="60" Margin="0,0,5,0" Click="RefreshRoles_Click"/>
                    </StackPanel>
                </Grid>
            </GroupBox>
            
            <!-- 右侧：权限树 -->
            <GroupBox Grid.Column="2" Header="可用权限（勾选以分配给所选角色）">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- 操作按钮 -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                        <Button Content="全选" Width="60" Margin="0,0,5,0" Click="SelectAll_Click"/>
                        <Button Content="全不选" Width="60" Margin="0,0,5,0" Click="DeselectAll_Click"/>
                        <TextBlock Text="" Width="20"/>
                        <TextBlock Text="当前角色：" VerticalAlignment="Center"/>
                        <TextBlock x:Name="CurrentRoleText" Text="未选择" FontWeight="Bold" VerticalAlignment="Center" Margin="5,0,0,0"/>
                    </StackPanel>
                    
                    <!-- 权限树形视图 -->
                    <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                        <TreeView x:Name="PermissionsTreeView">
                            <TreeView.Resources>
                                <!-- 组级别样式 -->
                                <HierarchicalDataTemplate DataType="{x:Type local:PermissionGroup}" ItemsSource="{Binding Permissions}">
                                    <StackPanel Orientation="Horizontal">
                                        <CheckBox x:Name="GroupCheckBox" 
                                                  IsChecked="{Binding IsAllSelected}" 
                                                  Content="{Binding GroupName}"
                                                  FontWeight="Bold"
                                                  Checked="GroupCheckBox_Checked"
                                                  Unchecked="GroupCheckBox_Unchecked"/>
                                        <TextBlock Text="{Binding Permissions.Count, StringFormat=' ({0}项)'}" 
                                                   Foreground="Gray" 
                                                   Margin="5,0,0,0"/>
                                    </StackPanel>
                                </HierarchicalDataTemplate>
                                
                                <!-- 权限级别样式 -->
                                <DataTemplate DataType="{x:Type local:PermissionItem}">
                                    <CheckBox IsChecked="{Binding IsSelected}" 
                                              Margin="20,2,0,2">
                                        <StackPanel>
                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold"/>
                                            <TextBlock Text="{Binding Code}" 
                                                       FontSize="10" 
                                                       Foreground="Gray"/>
                                            <TextBlock Text="{Binding Remark}" 
                                                       FontSize="10" 
                                                       Foreground="DarkGray"
                                                       TextWrapping="Wrap"
                                                       Visibility="{Binding HasRemark, Converter={StaticResource Boolean2VisibilityConverter}}"/>
                                        </StackPanel>
                                    </CheckBox>
                                </DataTemplate>
                            </TreeView.Resources>
                        </TreeView>
                    </ScrollViewer>
                    
                    <!-- 保存按钮 -->
                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,10,0,0">
                        <Button x:Name="SaveButton" 
                                Content="保存权限分配" 
                                Width="120" 
                                IsEnabled="False"
                                Click="SavePermissions_Click"
                                Style="{StaticResource ButtonPrimary}"/>
                    </StackPanel>
                </Grid>
            </GroupBox>
        </Grid>
        
        <!-- 底部状态栏 -->
        <StatusBar Grid.Row="2" Margin="0,10,0,0">
            <StatusBarItem>
                <TextBlock x:Name="StatusText" Text="就绪"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>
