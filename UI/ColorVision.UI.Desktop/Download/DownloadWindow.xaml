<Window x:Class="ColorVision.UI.Desktop.Download.DownloadWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:ColorVision.UI.Desktop.Download"
        xmlns:properties="clr-namespace:ColorVision.UI.Desktop.Properties"
        mc:Ignorable="d"
        Title="{x:Static properties:Resources.DownloadManager}" Height="600" Width="900"
        Background="{DynamicResource GlobalBackground}" Initialized="Window_Initialized">
    <Window.Resources>
        <Style TargetType="{x:Type TextBlock}">
            <Setter Property="Foreground" Value="{DynamicResource GlobalTextBrush}"/>
        </Style>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
    </Window.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,0,0,1">
            <Grid Margin="5,4">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button x:Name="BtnAddUrl" Content="{x:Static properties:Resources.AddDownload}" Click="BtnAddUrl_Click" Margin="2,0" Padding="8,3"/>
                    <Separator Margin="5,0"/>
                    <Button Content="{x:Static properties:Resources.ClearRecords}" Click="ClearRecords_Click" Margin="2,0" Padding="8,3"/>
                </StackPanel>

                <Grid Grid.Column="1" Margin="10,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>
                    <TextBox x:Name="SearchTextBox" Grid.Column="1" VerticalAlignment="Center" TextChanged="SearchTextBox_TextChanged"/>
                </Grid>

                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button Content="&#xE72C;" FontFamily="Segoe MDL2 Assets" FontSize="18"  ToolTip="{x:Static properties:Resources.Refresh}" Click="Refresh_Click" Margin="2,0" Padding="6,3" Background="Transparent" BorderThickness="0"/>
                    <Button Content="&#xE713;" FontFamily="Segoe MDL2 Assets" FontSize="22" ToolTip="{x:Static properties:Resources.DownloadSettings}" Click="Settings_Click" Margin="2,0" Padding="6,3" Background="Transparent" BorderThickness="0"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Download List -->
        <ListBox x:Name="DownloadListView" Grid.Row="1" Margin="0"
                 SelectionMode="Extended" HorizontalContentAlignment="Stretch"
                 ScrollViewer.HorizontalScrollBarVisibility="Disabled" BorderThickness="0"
                 MouseDoubleClick="DownloadListView_MouseDoubleClick">
            <ListBox.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="{x:Static properties:Resources.OpenFile}" Click="ContextMenu_OpenFile_Click"/>
                    <MenuItem Header="{x:Static properties:Resources.OpenFolder}" Click="ContextMenu_OpenFolder_Click"/>
                    <Separator/>
                    <MenuItem Header="{x:Static properties:Resources.CopyUrl}" Click="ContextMenu_CopyUrl_Click"/>
                    <Separator/>
                    <MenuItem Header="{x:Static properties:Resources.PauseDownload}" Click="ContextMenu_Pause_Click"/>
                    <MenuItem Header="{x:Static properties:Resources.ResumeDownload}" Click="ContextMenu_Resume_Click"/>
                    <MenuItem Header="{x:Static properties:Resources.RetryDownload}" Click="ContextMenu_Retry_Click"/>
                    <MenuItem Header="{x:Static properties:Resources.CancelDownload}" Click="ContextMenu_Cancel_Click"/>
                    <Separator/>
                    <MenuItem Header="{x:Static properties:Resources.DeleteRecord}" Click="ContextMenu_Delete_Click"/>
                </ContextMenu>
            </ListBox.ContextMenu>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Grid Height="58" Margin="4,2,4,2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="36"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- File Icon from OS -->
                        <Image Grid.Column="0" Source="{Binding FileIconSource}" Width="28" Height="28" VerticalAlignment="Center" HorizontalAlignment="Center"/>

                        <!-- Main content area -->
                        <Grid Grid.Column="1" Margin="8,2,8,2" VerticalAlignment="Center">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Row 0: FileName + FileSize + CreateTime -->
                            <DockPanel Grid.Row="0">
                                <TextBlock DockPanel.Dock="Right" Text="{Binding CreateTime, StringFormat=yyyy-MM-dd HH:mm}" FontSize="11" Foreground="Gray" VerticalAlignment="Center" Margin="8,0,0,0"/>
                                <TextBlock DockPanel.Dock="Right" Text="{Binding FileSizeDisplayText}" FontSize="11" Foreground="Gray" VerticalAlignment="Center" Margin="8,0,0,0"/>
                                <TextBlock Text="{Binding FileName}" TextTrimming="CharacterEllipsis" FontSize="13" VerticalAlignment="Center"/>
                            </DockPanel>

                            <!-- Row 1: Progress bar + speed (visible when downloading) -->
                            <Grid Grid.Row="1" Margin="0,4,0,0"
                                  Visibility="{Binding IsActiveDownloading, Converter={StaticResource BoolToVisibility}}">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <ProgressBar Value="{Binding ProgressValue}" Height="14" Minimum="0" Maximum="100"/>
                                <TextBlock Grid.Column="1" Text="{Binding SpeedText}" FontSize="11" Foreground="Gray" Margin="8,0,0,0" VerticalAlignment="Center" MinWidth="80" TextAlignment="Right"/>
                            </Grid>

                            <!-- Row 1: Status text (visible when NOT actively downloading) -->
                            <TextBlock Grid.Row="1" Text="{Binding StatusText}" FontSize="11" Foreground="Gray" Margin="0,4,0,0"
                                       VerticalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Foreground" Value="Gray"/>
                                        <Setter Property="Visibility" Value="Visible"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsActiveDownloading}" Value="True">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>

                        <!-- Action buttons (right side) -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="2,0,2,0">
                            <!-- Pause button: visible when actively downloading -->
                            <Button Content="&#xE769;" FontFamily="Segoe MDL2 Assets" FontSize="14"
                                    Background="Transparent" BorderThickness="0" Cursor="Hand"
                                    ToolTip="{x:Static properties:Resources.PauseDownload}"
                                    Click="InlinePause_Click" Padding="5,3" Margin="0,0,1,0"
                                    Visibility="{Binding IsActiveDownloading, Converter={StaticResource BoolToVisibility}}"/>
                            <!-- Resume button: visible when paused -->
                            <Button Content="&#xE768;" FontFamily="Segoe MDL2 Assets" FontSize="14"
                                    Background="Transparent" BorderThickness="0" Cursor="Hand"
                                    ToolTip="{x:Static properties:Resources.ResumeDownload}"
                                    Click="InlineResume_Click" Padding="5,3" Margin="0,0,1,0"
                                    Visibility="{Binding IsPaused, Converter={StaticResource BoolToVisibility}}"/>
                            <!-- Retry button: visible when failed -->
                            <Button Content="&#xE72C;" FontFamily="Segoe MDL2 Assets" FontSize="14"
                                    Background="Transparent" BorderThickness="0" Cursor="Hand"
                                    ToolTip="{x:Static properties:Resources.RetryDownload}"
                                    Click="InlineRetry_Click" Padding="5,3" Margin="0,0,1,0"
                                    Visibility="{Binding IsWaitingOrFailed, Converter={StaticResource BoolToVisibility}}"/>
                            <!-- OpenFolder button: visible when completed -->
                            <Button Content="&#xE838;" FontFamily="Segoe MDL2 Assets" FontSize="14"
                                    Background="Transparent" BorderThickness="0" Cursor="Hand"
                                    ToolTip="{x:Static properties:Resources.OpenFolder}"
                                    Click="InlineOpenFolder_Click" Padding="5,3" Margin="0,0,1,0"
                                    Visibility="{Binding IsCompleted, Converter={StaticResource BoolToVisibility}}"/>
                            <!-- Delete button: always visible -->
                            <Button Content="&#xE74D;" FontFamily="Segoe MDL2 Assets" FontSize="14"
                                    Background="Transparent" BorderThickness="0" Cursor="Hand"
                                    ToolTip="{x:Static properties:Resources.DeleteRecord}"
                                    Click="InlineDelete_Click" Padding="5,3"/>
                        </StackPanel>
                    </Grid>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- Status & Pagination Bar -->
        <Border Grid.Row="2" Height="28" Background="{DynamicResource GlobalBackground}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0">
            <Grid Margin="8,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <Ellipse x:Name="StatusIndicator" Width="8" Height="8" Fill="Gray" Margin="0,0,5,0" VerticalAlignment="Center"/>
                    <TextBlock x:Name="StatusBarText" Text="" FontSize="11" Foreground="Gray" VerticalAlignment="Center"/>
                </StackPanel>

                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="15,0,0,0">
                    <TextBlock Text="{x:Static properties:Resources.TotalRecords}" VerticalAlignment="Center" Margin="0,0,3,0" FontSize="11"/>
                    <TextBlock x:Name="TotalCountText" Text="0" VerticalAlignment="Center" FontSize="11"/>
                    <TextBlock Text="{x:Static properties:Resources.PageSize}" VerticalAlignment="Center" Margin="15,0,3,0" FontSize="11"/>
                    <ComboBox x:Name="PageSizeComboBox" BorderThickness="0" Style="{StaticResource ComboBox.Small}" Width="60" VerticalAlignment="Center" SelectionChanged="PageSizeComboBox_SelectionChanged">
                        <ComboBoxItem Content="20" IsSelected="True"/>
                        <ComboBoxItem Content="50"/>
                        <ComboBoxItem Content="100"/>
                    </ComboBox>
                </StackPanel>

                <StackPanel Grid.Column="3" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="|&lt;" Click="FirstPage_Click" Style="{StaticResource ButtonDefault.Small}" BorderThickness="0" Margin="1,0" Padding="2" />
                    <Button Content="&lt;" Click="PrevPage_Click" Style="{StaticResource ButtonDefault.Small}" BorderThickness="0" Margin="1,0" Padding="2" />
                    <TextBox x:Name="CurrentPageTextBox" Style="{StaticResource TextBox.Small}" BorderThickness="0" Text="1" FontSize="11"  VerticalAlignment="Center" TextAlignment="Center" KeyDown="CurrentPageTextBox_KeyDown"/>
                    <TextBlock Text="/" VerticalAlignment="Center" Margin="3,0" FontSize="11"/>
                    <TextBlock x:Name="TotalPagesText" Text="1" VerticalAlignment="Center" FontSize="11"/>
                    <Button Content="&gt;" Style="{StaticResource ButtonDefault.Small}" Click="NextPage_Click" BorderThickness="0" Margin="1,0" Padding="2"/>
                    <Button Content="&gt;|" Style="{StaticResource ButtonDefault.Small}" Click="LastPage_Click" BorderThickness="0" Margin="1,0" Padding="2"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
