<Window x:Class="ColorVision.UI.Desktop.Download.DownloadWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:ColorVision.UI.Desktop.Download"
        xmlns:properties="clr-namespace:ColorVision.UI.Desktop.Properties"
        mc:Ignorable="d"
        Title="{x:Static properties:Resources.DownloadManager}" Height="600" Width="900"
        Background="{DynamicResource GlobalBackground}" Initialized="Window_Initialized">
    <Window.Resources>
        <Style TargetType="{x:Type TextBlock}">
            <Setter Property="Foreground" Value="{DynamicResource GlobalTextBrush}"/>
        </Style>
        <BooleanToVisibilityConverter x:Key="BoolToVisibility"/>
    </Window.Resources>
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Grid Margin="5">
            <StackPanel Orientation="Horizontal" >
                <Button x:Name="BtnAddUrl" Content="{x:Static properties:Resources.AddDownload}" Click="BtnAddUrl_Click" Margin="2,0"/>
                <Separator Margin="5,0"/>
                <Button Content="{x:Static properties:Resources.ClearRecords}" Click="ClearRecords_Click" Margin="2,0"/>
                <Separator Margin="5,0"/>
                <TextBlock Text="{x:Static properties:Resources.Search}" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <TextBox x:Name="SearchTextBox" Width="200" VerticalAlignment="Center" TextChanged="SearchTextBox_TextChanged"/>
                <Separator Margin="5,0"/>
                <Button Content="{x:Static properties:Resources.Refresh}" Click="Refresh_Click" Margin="2,0"/>
                <Separator Margin="5,0"/>
                <Button Content="{x:Static properties:Resources.DownloadSettings}" Click="Settings_Click" Margin="2,0"/>
            </StackPanel>
        </Grid>

        <!-- Download List -->
        <ListBox x:Name="DownloadListView" Grid.Row="1" Margin="5,0,5,5"
                 SelectionMode="Extended" HorizontalContentAlignment="Stretch"
                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                 MouseDoubleClick="DownloadListView_MouseDoubleClick">
            <ListBox.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="{x:Static properties:Resources.OpenFile}" Click="ContextMenu_OpenFile_Click"/>
                    <MenuItem Header="{x:Static properties:Resources.OpenFolder}" Click="ContextMenu_OpenFolder_Click"/>
                    <Separator/>
                    <MenuItem Header="{x:Static properties:Resources.CopyUrl}" Click="ContextMenu_CopyUrl_Click"/>
                    <Separator/>
                    <MenuItem Header="{x:Static properties:Resources.PauseDownload}" Click="ContextMenu_Pause_Click"/>
                    <MenuItem Header="{x:Static properties:Resources.ResumeDownload}" Click="ContextMenu_Resume_Click"/>
                    <MenuItem Header="{x:Static properties:Resources.RetryDownload}" Click="ContextMenu_Retry_Click"/>
                    <MenuItem Header="{x:Static properties:Resources.CancelDownload}" Click="ContextMenu_Cancel_Click"/>
                    <Separator/>
                    <MenuItem Header="{x:Static properties:Resources.DeleteRecord}" Click="ContextMenu_Delete_Click"/>
                </ContextMenu>
            </ListBox.ContextMenu>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <Grid Height="68" Margin="2,2,2,2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="40"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- File Icon from OS -->
                        <Image Grid.Column="0" Source="{Binding FileIconSource}" Width="32" Height="32" VerticalAlignment="Center" HorizontalAlignment="Center"/>

                        <!-- Main content area -->
                        <Grid Grid.Column="1" Margin="6,4,6,4" VerticalAlignment="Center">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Row 0: FileName + FileSize + CreateTime -->
                            <Grid Grid.Row="0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="{Binding FileName}" TextTrimming="CharacterEllipsis" FontSize="13" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="1" Text="{Binding FileSizeDisplayText}" Margin="10,0,0,0" FontSize="11" Foreground="Gray" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="2" Text="{Binding CreateTime, StringFormat=yyyy-MM-dd HH:mm}" Margin="10,0,0,0" FontSize="11" Foreground="Gray" VerticalAlignment="Center"/>
                            </Grid>

                            <!-- Row 1: Progress bar (visible when downloading) -->
                            <Grid Grid.Row="1" Margin="0,4,0,0"
                                  Visibility="{Binding IsActiveDownloading, Converter={StaticResource BoolToVisibility}}">
                                <ProgressBar Value="{Binding ProgressValue}" Height="16" Minimum="0" Maximum="100"/>
                                <TextBlock HorizontalAlignment="Center" VerticalAlignment="Center" FontSize="10">
                                    <TextBlock.Text>
                                        <MultiBinding StringFormat="{}{0}%">
                                            <Binding Path="ProgressValue"/>
                                        </MultiBinding>
                                    </TextBlock.Text>
                                </TextBlock>
                            </Grid>

                            <!-- Row 2: Speed (visible when downloading) -->
                            <TextBlock Grid.Row="2" Text="{Binding SpeedText}" FontSize="11" Foreground="Gray" Margin="0,2,0,0"
                                       Visibility="{Binding IsActiveDownloading, Converter={StaticResource BoolToVisibility}}"/>

                            <!-- Row 1-2: Status text (visible when NOT actively downloading) -->
                            <TextBlock Grid.Row="1" Grid.RowSpan="2" Text="{Binding StatusText}" FontSize="12" Foreground="Gray" Margin="0,4,0,0"
                                       VerticalAlignment="Center">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Foreground" Value="Gray"/>
                                        <Setter Property="Visibility" Value="Visible"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsActiveDownloading}" Value="True">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </Grid>

                        <!-- Action buttons (right side) -->
                        <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="4,0,4,0">
                            <!-- Pause button: visible when actively downloading -->
                            <Button Content="&#xE769;" FontFamily="Segoe MDL2 Assets" FontSize="16"
                                    Background="Transparent" BorderThickness="0" Cursor="Hand"
                                    ToolTip="{x:Static properties:Resources.PauseDownload}"
                                    Click="InlinePause_Click" Padding="6,4" Margin="0,0,2,0"
                                    Visibility="{Binding IsActiveDownloading, Converter={StaticResource BoolToVisibility}}"/>
                            <!-- Resume button: visible when paused -->
                            <Button Content="&#xE768;" FontFamily="Segoe MDL2 Assets" FontSize="16"
                                    Background="Transparent" BorderThickness="0" Cursor="Hand"
                                    ToolTip="{x:Static properties:Resources.ResumeDownload}"
                                    Click="InlineResume_Click" Padding="6,4" Margin="0,0,2,0"
                                    Visibility="{Binding IsPaused, Converter={StaticResource BoolToVisibility}}"/>
                            <!-- OpenFolder button: visible when completed -->
                            <Button Content="&#xE838;" FontFamily="Segoe MDL2 Assets" FontSize="16"
                                    Background="Transparent" BorderThickness="0" Cursor="Hand"
                                    ToolTip="{x:Static properties:Resources.OpenFolder}"
                                    Click="InlineOpenFolder_Click" Padding="6,4" Margin="0,0,2,0"
                                    Visibility="{Binding IsCompleted, Converter={StaticResource BoolToVisibility}}"/>
                            <!-- Delete button: always visible -->
                            <Button Content="&#xE74D;" FontFamily="Segoe MDL2 Assets" FontSize="16"
                                    Background="Transparent" BorderThickness="0" Cursor="Hand"
                                    ToolTip="{x:Static properties:Resources.DeleteRecord}"
                                    Click="InlineDelete_Click" Padding="6,4"/>
                        </StackPanel>
                    </Grid>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- Status Bar -->
        <Border Grid.Row="2" Height="30" Background="{DynamicResource GlobalBackground}" BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0">
            <Grid Margin="5,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="{x:Static properties:Resources.TotalRecords}" Margin="0,0,5,0"/>
                    <TextBlock x:Name="TotalCountText" Text="0" Margin="0,0,20,0"/>
                    <TextBlock x:Name="StatusBarText" Text="" Margin="10,0,0,0" Foreground="Gray"/>
                    <TextBlock Text="{x:Static properties:Resources.PageSize}" Margin="20,0,5,0"/>
                    <ComboBox x:Name="PageSizeComboBox" Width="70" VerticalAlignment="Center" SelectionChanged="PageSizeComboBox_SelectionChanged">
                        <ComboBoxItem Content="20" IsSelected="True"/>
                        <ComboBoxItem Content="50"/>
                        <ComboBoxItem Content="100"/>
                    </ComboBox>
                </StackPanel>

                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                    <Button Content="|&lt;" Click="FirstPage_Click" Width="30" Margin="2,0"/>
                    <Button Content="&lt;" Click="PrevPage_Click" Width="30" Margin="2,0"/>
                    <TextBlock Text="{x:Static properties:Resources.Page}" VerticalAlignment="Center" Margin="5,0"/>
                    <TextBox x:Name="CurrentPageTextBox" Text="1" Width="50" VerticalAlignment="Center" TextAlignment="Center" KeyDown="CurrentPageTextBox_KeyDown"/>
                    <TextBlock Text="/" VerticalAlignment="Center" Margin="5,0"/>
                    <TextBlock x:Name="TotalPagesText" Text="1" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <Button Content="&gt;" Click="NextPage_Click" Width="30" Margin="2,0"/>
                    <Button Content="&gt;|" Click="LastPage_Click" Width="30" Margin="2,0"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
