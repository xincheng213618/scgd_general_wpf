# 许可证系统

ColorVision 使用增强型许可证系统来管理软件授权。

## 增强型许可证

增强型许可证采用 Base64 编码的 JSON 格式，包含以下信息：

- **licensee**: 被许可人
- **device_mode**: 设备模式
- **expiry_date**: 到期日期（Unix时间戳）
- **issue_date**: 签发日期
- **issuing_authority**: 签发机构
- **authority_signature**: 机构签名
- **licensee_signature**: 被许可人签名

## 许可证检测

SDK 提供 license 的导入验证和查询，根据 sn 和注册文件可以查询设备的种类、有效日期和注册是否有效等信息。

### 使用方式

1. **本机调用**：本机先调用SDK的查询ID接口，然后再调用本机的查询license的验证接口，最后前端展示。

2. **服务调用**：对外提供查询的接口（CM_GetAllSnID），先拿到所有的设备id、sn，然后去做匹配。展示的字段应该包含设备id、sn、是否有效、有效期、设备类型（不需要到设备，因为存在bv cv可以混用的情况）。

## 配置中心

配置中心是独立的exe，前端登录需要密码（管理员）。配置中心在启动的时候同时监听MQTT服务，配置中心的信道是约定的。

配置中心目前暂时提供服务的管理功能，即配置中心是和服务进行主动通信，监听和保存服务的状态。

在各个服务资源提供节点（连接各种终端的PC）需要安装用于服务管理的服务，该服务与配置中心进行通讯。提供服务的开启、关闭、重启、信道的再分配（这个功能是为了后续的迭代没有更多的意义）。

同时提供资源的管理功能，即注册中心会管理这些服务下设备的所有的许可证，并负责存入库中。

可以在这里直接配置许可证。

## 许可证管理流程

服务在启动的时候，会先主动运行CM_GetAllSnID（只要调用了这个，就会发送到配置中心），然后把结果包含许可证的base64信息，发送到配置中心（仅一次）。配置中心会把所有ID和本地的license做匹配（调用SDK），如果服务中这个SN没有注册证，但配置中心存在，则会把这个SN和结果返回到服务本身，服务应该把结果调用SDK保存。如果配置中心没有这个SN，则会增量添加一次。

SDK许可证的优先级为覆盖，无效的覆盖有效的，时间长的覆盖时间短的（配置中心决定，服务不判断）。

## 前端功能

前端调用 CM_GetAllSnID，拿到ID、SN、有效期做展示和控制。同时前端提供导入的按钮。导入是针对服务的，服务在导入的时候，会把这个信息上传配置中心。

前端不直接和配置中心通讯，配置中心和服务通讯，配置中心的结果和数据库同步。 

前端和数据库同步。前端和服务通讯。

## 管理员模式

前端中，管理员模式可以看到服务下面的设备，并且可以对下面的设备进行增删改查的逻辑处理，以及分配某个资源给某个用户。

用户和租户的关系属于两级映射，即一个用户可以持有多个租户。一个资源只能被一个租户持有，相当于是资源组的概念。

## 用户模式

前端中，直接进入是用户模式，用户模式下，会看到自己持有的资源列表，并且在这里可以看到心跳和初始化。

完成初始化的资源可以被实例化到主窗口中进行通讯。

然后进入主窗口的时候，会把资源列表实例化到主窗口中。
